---
- name: Repmgr | Update configuration (repmgr.conf)
  template:
    src: "repmgr.conf-{{ repmgr_version }}.j2"
    dest: "{{postgresql_conf_directory}}/repmgr.conf"
    owner: "{{ postgresql_service_user }}"
    group: "{{ postgresql_service_group }}"
    mode: 0640

- name: Repmgr | Create repmgr.conf symlink for shorter commands # see: https://repmgr.org/docs/4.0/configuration-file.html
  file:
    src: "{{postgresql_conf_directory}}/repmgr.conf"
    dest: /etc/repmgr.conf 
    state: link

- name: Repmgr | Ensure systemd drop-in directory exists
  file:
    path: "/etc/systemd/system/repmgr{{postgresql_version}}.service.d/"
    state: directory
    mode: 0755

- name: Repmgr | Update drop-in
  template:
    src: "repmgr.custom.conf.j2"
    dest: "/etc/systemd/system/repmgr{{postgresql_version}}.service.d/custom.conf"

- name: Repmgr | Allow passwordless restarts with postgres user
  template:
    src: "sudoers.postgresql.j2"
    dest: "/etc/sudoers.d/postgresql"
    mode: 0640

- name: Repmgr | Update .pgpass for postgres user
  template:
    src: "pgpass.j2"
    dest: "{{repmgr_passfile}}"
    owner: "{{ postgresql_service_user }}"
    group: "{{ postgresql_service_group }}"
    mode: 0600
    trim_blocks: no

- name: Repmgr | Ensure ssh keys destination folder exists
  file: 
    path: "{{repmgr_base_key_path}}"
    state: directory
    owner: "{{ postgresql_service_user }}"
    group: "{{ postgresql_service_group }}"
    mode: 0700

- name: Rempgr | Generate local SSH keypair (Native module version)
  openssh_keypair:
    path: /tmp/id_rsa
    size: 2048
    owner: root
    mode: 0775
  delegate_to: localhost

- name: Repmgr | Fetch pubkey content
  set_fact:
    pubkey_content: "{{ lookup('file', '/tmp/id_rsa.pub') }}"
  become: yes

- debug: "var=pubkey_content"

- name: Repmgr | Update authorized_keys on all nodes
  authorized_key:
    user: "{{ postgresql_service_user }}"
    key: "{{pubkey_content}}"
    state: present

- name: Repmgr | Upload private key on all nodes
  copy:
    src: "/tmp/id_rsa"
    dest: "{{ repmgr_private_key_path }}"
    owner: "{{ postgresql_service_user }}"
    group: "{{ postgresql_service_group }}"
    mode: 0600

- name: Determine repmgr primary hostname
  set_fact:
    repmgr_primary_hostname: "{% for host, vars in hostvars.items() if 'repmgr_primary' in vars and vars['repmgr_primary'] == True %}{{ host|trim }}{% endfor %}"

- name: Repmgr | Register as primary
  command: "repmgr primary register"
  become: yes
  become_user: "{{ postgresql_service_user }}"
  when: repmgr_primary

- name: Repmgr | Ensure postgresql slave is stopped before clone
  service:
    name: "postgresql@{{postgresql_version}}-{{postgresql_cluster_name}}"
    state: stopped
  when: not repmgr_primary

- name: Repmgr | Clone standby
  command: "repmgr -F {{repmgr_primary_hostname}} -U repmgr -d repmgr standby clone"
  become: yes
  become_user: "{{ postgresql_service_user }}"
  when: not repmgr_primary

- name: Repmgr | Ensure postgresql slave is running after clone
  service:
    name: "postgresql@{{postgresql_version}}@{{postgresql_cluster_name}}"
    state: started
  when: not repmgr_primary

- name: Repmgr | Wait for Postgres
  wait_for:
    timeout: 3
  delegate_to: localhost

- name: Repmgr | Register standby
  command: "repmgr -F {{repmgr_primary_hostname}} -U repmgr -d repmgr standby register"
  become: yes
  become_user: "{{ postgresql_service_user }}"
  when: not repmgr_primary

- name: Repmgr | Verify cluster functionality
  command: "repmgr -F {{repmgr_primary_hostname}} -U repmgr -d repmgr cluster crosscheck"
  become: yes
  become_user: "{{ postgresql_service_user }}"

- name: Repmgr | Ensure repmgrd is running
  service:
    name: "repmgrd"
    state: started
    enabled: yes
  when: repmgr_monitoring_history == "true" or repmgr_failover == "automatic"

- name: Repmgr | Setup cluster monitoring history cleanup
  copy:
    content: "repmgr cluster cleanup --keep-history={{repmgr_keep_history_days}}"
    dest: "/etc/cron.daily/repmgr_cleanup"
    mode: 0755
  when: repmgr_monitoring_history == "true" or repmgr_failover == "automatic"
